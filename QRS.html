<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Russian Stack</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@exampledev/new.css@1.1.2/new.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/socket.io.min.js"></script>
    <style>
        :root {
            --nc-tx-1: #ffffff;
            --nc-tx-2: #eeeeee;
            --nc-bg-1: #1a1a1a;
            --nc-bg-2: #2a2a2a;
            --nc-bg-3: #3a3a3a;
            --nc-lk-1: #3291ff;
            --nc-lk-2: #0070f3;
            --nc-ac-1: #7928ca;
            --nc-ac-tx: #ffffff;
        }
        
        body {
            background: var(--nc-bg-1);
            color: var(--nc-tx-2);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            margin-bottom: 15px;
            position: sticky;
            top: 10px;
            z-index: 100;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 18px;
        }
        
        .status {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .status-badge {
            background: rgba(0,200,0,0.2);
            border: 1px solid rgba(0,200,0,0.5);
            color: #00ff00;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 15px;
        }
        
        .card {
            background: var(--nc-bg-2);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--nc-bg-3);
        }
        
        .card-title {
            font-weight: 600;
            font-size: 16px;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .metric {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .metric-label {
            font-size: 12px;
            color: var(--nc-tx-2);
            opacity: 0.7;
        }
        
        .metric-value {
            font-size: 22px;
            font-weight: 600;
        }
        
        .progress-container {
            background: var(--nc-bg-3);
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3291ff, #0070f3);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin: 5px 0;
            width: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, #3291ff, #0070f3);
        }
        
        .btn-warning {
            background: linear-gradient(90deg, #ff9500, #ff7300);
        }
        
        .slider {
            width: 100%;
            height: 4px;
            background: var(--nc-bg-3);
            border-radius: 2px;
            margin: 10px 0;
        }
        
        .task-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .task-item {
            background: var(--nc-bg-3);
            padding: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .task-info {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .task-name {
            font-weight: 500;
        }
        
        .task-desc {
            font-size: 12px;
            opacity: 0.7;
        }
        
        .blink {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Адаптация для мобильных устройств */
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .header {
                padding: 8px 10px;
            }
            
            .logo {
                font-size: 16px;
            }
            
            .card {
                padding: 12px;
            }
            
            .metric-value {
                font-size: 20px;
            }
        }
        
        /* Специфичные стили для iPhone 11 */
        @media only screen 
            and (device-width: 414px) 
            and (device-height: 896px) 
            and (-webkit-device-pixel-ratio: 2) {
            .container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <i class="fas fa-atom"></i>
                Quantum Russian Stack
            </div>
            <div class="status">
                <div class="status-badge" id="system-status">
                    <i class="fas fa-circle"></i> АКТИВЕН
                </div>
                <div id="current-time">--:--:--</div>
            </div>
        </div>
        
        <div class="grid">
            <!-- Системные метрики -->
            <div class="card" style="grid-column: span 4;">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-heartbeat"></i> Состояние системы</h3>
                </div>
                <div class="metric">
                    <span class="metric-label">Загрузка CPU</span>
                    <span class="metric-value" id="cpu-usage-text">0%</span>
                    <div class="progress-container">
                        <div class="progress-bar" id="cpu-usage" style="width: 0%"></div>
                    </div>
                </div>
                <div class="metric">
                    <span class="metric-label">Использование памяти</span>
                    <span class="metric-value" id="memory-usage-text">0%</span>
                    <div class="progress-container">
                        <div class="progress-bar" id="memory-usage" style="width: 0%"></div>
                    </div>
                </div>
                <div class="metric">
                    <span class="metric-label">Температура CPU</span>
                    <span class="metric-value" id="cpu-temp-text">0°C</span>
                    <div class="progress-container">
                        <div class="progress-bar" id="cpu-temp" style="width: 0%; background: #ff3b30;"></div>
                    </div>
                </div>
                <div class="metric">
                    <span class="metric-label">Скорость эмуляции</span>
                    <span class="metric-value" id="emulation-speed">0 q/сек</span>
                </div>
            </div>
            
            <!-- Квантовые метрики -->
            <div class="card" style="grid-column: span 4;">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-question-circle"></i> Квантовые метрики</h3>
                </div>
                <div class="metric">
                    <span class="metric-label">Ошибка кубитов</span>
                    <span class="metric-value" id="qubit-error-value">0.0000</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Точность гейтов</span>
                    <span class="metric-value" id="gate-fidelity-value">0.0000</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Энтропия состояния</span>
                    <span class="metric-value" id="state-entropy-value">0.00</span>
                    <div class="progress-container">
                        <div class="progress-bar" id="state-entropy-bar" style="width: 0%; background: linear-gradient(90deg, #7928ca, #ff0080);"></div>
                    </div>
                </div>
            </div>
            
            <!-- Безопасность -->
            <div class="card" style="grid-column: span 4;">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-shield-alt"></i> Безопасность</h3>
                </div>
                <div class="metric">
                    <span class="metric-label">Шифрование</span>
                    <span class="metric-value" id="encryption-status">Активно</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Последняя ротация</span>
                    <span class="metric-value" id="key-rotation-time">--:--:--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">До следующей ротации</span>
                    <span class="metric-value" id="key-expiration">--:--:--</span>
                </div>
                <button class="btn btn-warning" id="rotate-keys-btn">
                    <i class="fas fa-sync-alt"></i> Ротация ключей
                </button>
            </div>
            
            <!-- Графики -->
            <div class="card" style="grid-column: span 8;">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-chart-line"></i> Производительность</h3>
                </div>
                <canvas id="real-time-chart" height="200"></canvas>
            </div>
            
            <!-- Квантовое состояние -->
            <div class="card" style="grid-column: span 4;">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-project-diagram"></i> Квантовое состояние</h3>
                </div>
                <canvas id="quantum-state-chart" height="200"></canvas>
            </div>
            
            <!-- Управление ИИ -->
            <div class="card" style="grid-column: span 6;">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-brain"></i> Управление ИИ</h3>
                </div>
                <div class="metric">
                    <span class="metric-label">Уровень автономности</span>
                    <span class="metric-value" id="ai-autonomy-level">75%</span>
                    <input type="range" min="0" max="100" value="75" class="slider" id="ai-autonomy-slider">
                </div>
                <div class="metric">
                    <span class="metric-label">Статус обучения</span>
                    <span class="metric-value" id="ai-training-status">Готов</span>
                </div>
                <button class="btn" id="start-training-btn">
                    <i class="fas fa-play"></i> Запустить обучение
                </button>
                <button class="btn btn-primary" id="optimize-ai-btn">
                    <i class="fas fa-magic"></i> Оптимизировать параметры
                </button>
            </div>
            
            <!-- Управление шумами -->
            <div class="card" style="grid-column: span 6;">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-sliders-h"></i> Управление шумами</h3>
                </div>
                <div class="metric">
                    <span class="metric-label">Уровень шума</span>
                    <span class="metric-value" id="noise-level-value">50%</span>
                    <input type="range" min="0" max="100" value="50" class="slider" id="noise-level-slider">
                </div>
                <button class="btn" id="calibrate-noise-btn">
                    <i class="fas fa-tachometer-alt"></i> Калибровать
                </button>
                <button class="btn" id="auto-adjust-btn">
                    <i class="fas fa-robot"></i> Автоподстройка
                </button>
            </div>
            
            <!-- Задачи -->
            <div class="card" style="grid-column: span 6;">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-tasks"></i> Примеры задач</h3>
                </div>
                <div class="task-list">
                    <div class="task-item">
                        <div class="task-info">
                            <span class="task-name">Калибровка кубитов</span>
                            <span class="task-desc">Оптимизация базовых параметров системы</span>
                        </div>
                        <button class="btn" style="width: auto; padding: 5px 10px;" onclick="runTask('calibration')">
                            <i class="fas fa-play"></i>
                        </button>
                    </div>
                    <div class="task-item">
                        <div class="task-info">
                            <span class="task-name">Тест алгоритма Шора</span>
                            <span class="task-desc">Факторизация простых чисел</span>
                        </div>
                        <button class="btn" style="width: auto; padding: 5px 10px;" onclick="runTask('shor')">
                            <i class="fas fa-play"></i>
                        </button>
                    </div>
                    <div class="task-item">
                        <div class="task-info">
                            <span class="task-name">Оптимизация QAOA</span>
                            <span class="task-desc">Максимизация точности вычислений</span>
                        </div>
                        <button class="btn" style="width: auto; padding: 5px 10px;" onclick="runTask('qaoa')">
                            <i class="fas fa-play"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Управление системой -->
            <div class="card" style="grid-column: span 6;">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-cogs"></i> Управление системой</h3>
                </div>
                <button class="btn" id="full-scan-btn">
                    <i class="fas fa-search"></i> Полное сканирование
                </button>
                <button class="btn" id="diagnostics-btn">
                    <i class="fas fa-stethoscope"></i> Диагностика
                </button>
                <button class="btn btn-primary" id="emergency-stop-btn">
                    <i class="fas fa-stop-circle"></i> Аварийная остановка
                </button>
                <button class="btn" id="mobile-mode-btn">
                    <i class="fas fa-mobile-alt"></i> Режим телефона
                </button>
            </div>
        </div>
    </div>

    <script>
        // Инициализация Socket.IO
        const socket = io();
        
        // Инициализация графиков
        const realTimeCtx = document.getElementById('real-time-chart').getContext('2d');
        const quantumStateCtx = document.getElementById('quantum-state-chart').getContext('2d');
        
        // График производительности
        const realTimeChart = new Chart(realTimeCtx, {
            type: 'line',
            data: {
                labels: Array(20).fill(''),
                datasets: [
                    {
                        label: 'Ошибка кубитов (x1000)',
                        data: Array(20).fill(0),
                        borderColor: '#ff3b30',
                        backgroundColor: 'rgba(255, 59, 48, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: 'Скорость эмуляции (q/сек)',
                        data: Array(20).fill(0),
                        borderColor: '#34c759',
                        backgroundColor: 'rgba(52, 199, 89, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: '#ffffff'
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(255,255,255,0.1)'
                        },
                        ticks: {
                            color: '#aaaaaa'
                        }
                    },
                    y: {
                        grid: {
                            color: 'rgba(255,255,255,0.1)'
                        },
                        ticks: {
                            color: '#aaaaaa'
                        },
                        beginAtZero: true
                    }
                }
            }
        });

        // Круговая диаграмма квантового состояния
        const quantumStateChart = new Chart(quantumStateCtx, {
            type: 'doughnut',
            data: {
                labels: ['Запутанность', 'Суперпозиция', 'Шум'],
                datasets: [{
                    data: [45, 35, 20],
                    backgroundColor: [
                        '#007aff',
                        '#5856d6',
                        '#ff2d55'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: '#ffffff'
                        }
                    }
                },
                cutout: '70%'
            }
        });

        // Обновление времени
        function updateClock() {
            const now = new Date();
            document.getElementById('current-time').textContent = 
                now.toLocaleTimeString('ru-RU', {hour12: false});
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Обработка событий Socket.IO
        socket.on('metrics_update', (data) => {
            // Системные метрики
            document.getElementById('cpu-usage-text').textContent = `${data.system.cpu_usage.toFixed(1)}%`;
            document.getElementById('cpu-usage').style.width = `${data.system.cpu_usage}%`;
            
            document.getElementById('memory-usage-text').textContent = `${data.system.memory_usage.toFixed(1)}%`;
            document.getElementById('memory-usage').style.width = `${data.system.memory_usage}%`;
            
            document.getElementById('cpu-temp-text').textContent = `${data.system.temperature.toFixed(1)}°C`;
            const tempWidth = Math.min(100, data.system.temperature);
            document.getElementById('cpu-temp').style.width = `${tempWidth}%`;
            
            // Цвет индикатора температуры
            const tempBar = document.getElementById('cpu-temp');
            if (data.system.temperature > 80) {
                tempBar.style.background = '#ff3b30';
            } else if (data.system.temperature > 60) {
                tempBar.style.background = '#ff9500';
            } else {
                tempBar.style.background = '#34c759';
            }

            // Квантовые метрики
            document.getElementById('qubit-error-value').textContent = data.quantum.qubit_error.toFixed(6);
            document.getElementById('gate-fidelity-value').textContent = data.quantum.gate_fidelity.toFixed(4);
            document.getElementById('state-entropy-value').textContent = data.quantum.state_entropy.toFixed(2);
            document.getElementById('state-entropy-bar').style.width = `${data.quantum.state_entropy * 100}%`;
            
            // Скорость эмуляции
            const speed = (data.quantum.emulation_speed || 0).toFixed(0);
            document.getElementById('emulation-speed').textContent = `${speed} q/сек`;
            
            // Обновление графиков
            const timeLabel = new Date(data.timestamp).toLocaleTimeString('ru-RU', {hour12: false});
            
            realTimeChart.data.labels.push(timeLabel);
            if (realTimeChart.data.labels.length > 20) realTimeChart.data.labels.shift();
            
            realTimeChart.data.datasets[0].data.push(data.quantum.qubit_error * 1000);
            if (realTimeChart.data.datasets[0].data.length > 20) realTimeChart.data.datasets[0].data.shift();
            
            realTimeChart.data.datasets[1].data.push(data.quantum.emulation_speed || 0);
            if (realTimeChart.data.datasets[1].data.length > 20) realTimeChart.data.datasets[1].data.shift();
            
            realTimeChart.update();
            
            quantumStateChart.data.datasets[0].data = [
                data.quantum.state_entropy * 70,
                (1 - data.quantum.state_entropy) * 70,
                data.quantum.qubit_error * 1000
            ];
            quantumStateChart.update();
            
            // Безопасность
            const rotationTime = new Date(data.security.last_key_rotation);
            document.getElementById('key-rotation-time').textContent = 
                rotationTime.toLocaleTimeString('ru-RU', {hour12: false});
            
            const nextRotation = new Date(rotationTime);
            nextRotation.setSeconds(nextRotation.getSeconds() + data.security.key_rotation_interval);
            const timeLeft = Math.max(0, Math.floor((nextRotation - new Date()) / 1000));
            
            const hours = Math.floor(timeLeft / 3600);
            const minutes = Math.floor((timeLeft % 3600) / 60);
            const seconds = timeLeft % 60;
            
            document.getElementById('key-expiration').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeLeft < 300) {
                document.getElementById('key-expiration').classList.add('blink');
                document.getElementById('key-expiration').style.color = '#ff3b30';
            } else {
                document.getElementById('key-expiration').classList.remove('blink');
                document.getElementById('key-expiration').style.color = '';
            }
        });

        // Управление элементами интерфейса
        document.getElementById('rotate-keys-btn').addEventListener('click', () => {
            const btn = document.getElementById('rotate-keys-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Ротация...';
            
            fetch('/control', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    command: 'rotate_keys'
                })
            })
            .then(response => response.json())
            .then(data => {
                showNotification(data.status === 'success' ? 
                    'Ключи успешно ротированы' : 'Ошибка: ' + data.message, 
                    data.status === 'success' ? 'success' : 'error');
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sync-alt"></i> Ротация ключей';
            });
        });

        document.getElementById('noise-level-slider').addEventListener('input', (e) => {
            const value = e.target.value;
            document.getElementById('noise-level-value').textContent = `${value}%`;
            
            fetch('/control', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    command: 'adjust_noise',
                    level: value / 100
                })
            });
        });

        document.getElementById('mobile-mode-btn').addEventListener('click', () => {
            document.body.classList.toggle('mobile-optimized');
            showNotification('Режим телефона ' + 
                (document.body.classList.contains('mobile-optimized') ? 'активирован' : 'деактивирован'), 
                'success');
        });

        // Запуск задач
        function runTask(taskType) {
            showNotification(`Задача "${getTaskName(taskType)}" запущена`, 'info');
            
            fetch('/control', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    command: 'run_task',
                    task: taskType
                })
            });
        }
        
        function getTaskName(taskType) {
            const tasks = {
                'calibration': 'Калибровка кубитов',
                'shor': 'Тест алгоритма Шора',
                'qaoa': 'Оптимизация QAOA'
            };
            return tasks[taskType] || taskType;
        }

        // Уведомления
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-icon">
                    ${type === 'success' ? '<i class="fas fa-check-circle"></i>' : 
                      type === 'error' ? '<i class="fas fa-exclamation-circle"></i>' : 
                      '<i class="fas fa-info-circle"></i>'}
                </div>
                <div class="notification-content">${message}</div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Стили для уведомлений
        const notificationStyles = document.createElement('style');
        notificationStyles.textContent = `
            .notification {
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(0,0,0,0.8);
                backdrop-filter: blur(20px);
                border-radius: 12px;
                padding: 15px;
                display: flex;
                align-items: center;
                gap: 15px;
                max-width: 300px;
                transform: translateX(100%);
                opacity: 0;
                transition: all 0.3s ease;
                z-index: 1000;
                border-left: 4px solid;
            }
            
            .notification.show {
                transform: translateX(0);
                opacity: 1;
            }
            
            .notification.success {
                border-left-color: #34c759;
            }
            
            .notification.error {
                border-left-color: #ff3b30;
            }
            
            .notification.info {
                border-left-color: #007aff;
            }
            
            .notification-icon {
                font-size: 20px;
            }
            
            .notification.success .notification-icon {
                color: #34c759;
            }
            
            .notification.error .notification-icon {
                color: #ff3b30;
            }
            
            .notification.info .notification-icon {
                color: #007aff;
            }
            
            .notification-content {
                font-size: 14px;
            }
            
            /* Мобильная оптимизация */
            .mobile-optimized .card {
                padding: 10px;
            }
            
            .mobile-optimized .metric-value {
                font-size: 18px;
            }
            
            .mobile-optimized .btn {
                padding: 6px 10px;
                font-size: 13px;
            }
        `;
        document.head.appendChild(notificationStyles);
        
        // Проверка iPhone 11
        function isiPhone11() {
            return /iPhone11/.test(navigator.userAgent) || 
                  (window.screen.width === 414 && window.screen.height === 896);
        }
        
        if (isiPhone11()) {
            document.body.classList.add('mobile-optimized');
            showNotification('Оптимизировано для iPhone 11', 'info');
        }
    </script>
</body>
</html>